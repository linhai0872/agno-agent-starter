#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Agno CLI - é€šç”¨ Agent/Team/Workflow æµ‹è¯•ä¸è°ƒè¯•å·¥å…·
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ç”¨æ³•:
#   ./scripts/agno run <type> <id> '<message>' [options]
#   ./scripts/agno trace <session_id> [options]
#   ./scripts/agno list [type]
#   ./scripts/agno sessions [type] [id] [limit]
#
# ç¤ºä¾‹:
#   ./scripts/agno run workflow customer-service '{"query":"How to reset password?"}'
#   ./scripts/agno run agent github-analyzer '{"repo":"owner/repo"}'
#   ./scripts/agno run team deep-research-team '{"query":"AI trends"}'
#   ./scripts/agno trace abc123-session-id
#   ./scripts/agno list
#   ./scripts/agno sessions workflow customer-service 5
#
# ç¯å¢ƒå˜é‡:
#   AGNO_PORT          - API ç«¯å£ (é»˜è®¤: 7777)
#   AGNO_DB_CONTAINER  - PostgreSQL å®¹å™¨å (é»˜è®¤: agno-postgres)
#   AGNO_DB_USER       - æ•°æ®åº“ç”¨æˆ· (é»˜è®¤: ai)
#   AGNO_DB_NAME       - æ•°æ®åº“å (é»˜è®¤: ai)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# é…ç½®
PORT="${AGNO_PORT:-7777}"
DB_CONTAINER="${AGNO_DB_CONTAINER:-agno-postgres}"
DB_USER="${AGNO_DB_USER:-ai}"
DB_NAME="${AGNO_DB_NAME:-ai}"
BASE_URL="http://127.0.0.1:${PORT}"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo "Agno CLI - é€šç”¨ Agent/Team/Workflow æµ‹è¯•ä¸è°ƒè¯•å·¥å…·"
    echo ""
    echo "ç”¨æ³•:"
    echo "  agno run <type> <id> '<message>' [--stream]    è¿è¡Œåº”ç”¨"
    echo "  agno trace <session_id> [--full|--metrics|--steps|--content|--usage]"
    echo "  agno list [type]                               åˆ—å‡ºå·²æ³¨å†Œçš„åº”ç”¨"
    echo "  agno sessions [type] [id] [limit]              æŸ¥çœ‹ session å†å²"
    echo "  agno errors [--limit N]                        æŸ¥çœ‹å¤±è´¥çš„ runs"
    echo "  agno health                                    ç³»ç»Ÿå¥åº·æ£€æŸ¥"
    echo ""
    echo "ç±»å‹ (type):"
    echo "  agent    - å• Agent åº”ç”¨"
    echo "  team     - å¤š Agent åä½œ"
    echo "  workflow - å·¥ä½œæµ (Sequential Chain)"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  agno run workflow customer-service '{\"query\":\"help\"}'"
    echo "  agno trace abc123-session-id --metrics"
    echo "  agno list workflow"
    echo "  agno errors --limit 5"
    echo "  agno health"
    echo "  agno sessions workflow customer-service 5"
}

# æ£€æŸ¥ä¾èµ–
check_deps() {
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}âŒ éœ€è¦å®‰è£… jq${NC}"
        exit 1
    fi
    if ! command -v curl &> /dev/null; then
        echo -e "${RED}âŒ éœ€è¦å®‰è£… curl${NC}"
        exit 1
    fi
}

# åˆ—å‡ºåº”ç”¨
cmd_list() {
    local type="${1:-all}"
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“‹ å·²æ³¨å†Œçš„åº”ç”¨ (ç«¯å£: $PORT)${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ "$type" = "all" ] || [ "$type" = "agent" ] || [ "$type" = "agents" ]; then
        echo -e "${BLUE}ğŸ¤– Agents:${NC}"
        curl -4 -s "${BASE_URL}/agents" | jq -r '.[] | "   - \(.id): \(.name // "N/A")"' 2>/dev/null || echo "   (æ— æ³•è·å–)"
        echo ""
    fi
    
    if [ "$type" = "all" ] || [ "$type" = "team" ] || [ "$type" = "teams" ]; then
        echo -e "${BLUE}ğŸ‘¥ Teams:${NC}"
        curl -4 -s "${BASE_URL}/teams" | jq -r '.[] | "   - \(.id): \(.name // "N/A")"' 2>/dev/null || echo "   (æ— æ³•è·å–)"
        echo ""
    fi
    
    if [ "$type" = "all" ] || [ "$type" = "workflow" ] || [ "$type" = "workflows" ]; then
        echo -e "${BLUE}ğŸ”„ Workflows:${NC}"
        curl -4 -s "${BASE_URL}/workflows" | jq -r '.[] | "   - \(.id): \(.name // "N/A")"' 2>/dev/null || echo "   (æ— æ³•è·å–)"
        echo ""
    fi
}

# è¿è¡Œåº”ç”¨
cmd_run() {
    local type="$1"
    local id="$2"
    local message="$3"
    local stream="${4:-false}"
    
    if [ -z "$type" ] || [ -z "$id" ] || [ -z "$message" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: agno run <type> <id> '<message>' [--stream]${NC}"
        echo "   type: agent | team | workflow"
        exit 1
    fi
    
    # å¤„ç† --stream å‚æ•°
    if [ "$stream" = "--stream" ]; then
        stream="true"
    else
        stream="false"
    fi
    
    # è§„èŒƒåŒ– type
    case "$type" in
        agent|agents) type="agents" ;;
        team|teams) type="teams" ;;
        workflow|workflows) type="workflows" ;;
        *)
            echo -e "${RED}âŒ æœªçŸ¥ç±»å‹: $type (æ”¯æŒ: agent, team, workflow)${NC}"
            exit 1
            ;;
    esac
    
    local endpoint="${BASE_URL}/${type}/${id}/runs"
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸš€ è¿è¡Œ ${type}/${id}${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}ğŸ“ è¾“å…¥:${NC} $message"
    echo -e "${BLUE}ğŸ”Œ ç«¯ç‚¹:${NC} $endpoint"
    echo -e "${BLUE}ğŸ“¡ æµå¼:${NC} $stream"
    echo ""
    
    echo -e "${YELLOW}â³ æ‰§è¡Œä¸­...${NC}"
    
    local response
    response=$(curl -4 -s -X POST "$endpoint" \
        -H 'Content-Type: application/x-www-form-urlencoded' \
        --data-urlencode "message=${message}" \
        --data-urlencode "stream=${stream}" 2>&1)
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ curl è¯·æ±‚å¤±è´¥${NC}"
        echo "$response"
        exit 1
    fi
    
    # æå– session_id
    local session_id
    session_id=$(echo "$response" | jq -r '.session_id // empty' 2>/dev/null)
    
    if [ -z "$session_id" ]; then
        echo -e "${RED}âŒ æ‰§è¡Œå¤±è´¥æˆ–æ— æ³•è§£æ session_id${NC}"
        echo ""
        echo "åŸå§‹å“åº”:"
        echo "$response" | jq . 2>/dev/null || echo "$response"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… æ‰§è¡Œå®Œæˆ${NC}"
    echo -e "${BLUE}ğŸ“‹ Session ID:${NC} $session_id"
    echo ""
    
    # è‡ªåŠ¨æŸ¥è¯¢ Trace
    cmd_trace "$session_id" "--summary"
    
    echo ""
    echo -e "${CYAN}ğŸ’¡ æ›´å¤šæŸ¥è¯¢:${NC}"
    echo "   agno trace $session_id --full     # å®Œæ•´ä¿¡æ¯"
    echo "   agno trace $session_id --metrics  # æ‰§è¡ŒæŒ‡æ ‡"
    echo "   agno trace $session_id --steps    # èŠ‚ç‚¹ç»“æœ"
    echo "   agno trace $session_id --content  # æœ€ç»ˆè¾“å‡º"
    echo "   agno trace $session_id --usage    # å·¥å…·æˆæœ¬ç»Ÿè®¡"
}

# æŸ¥è¯¢ Trace
cmd_trace() {
    local session_id="$1"
    local mode="${2:---summary}"
    
    if [ -z "$session_id" ]; then
        echo -e "${RED}âŒ ç”¨æ³•: agno trace <session_id> [--full|--metrics|--steps|--content|--usage|--summary]${NC}"
        exit 1
    fi
    
    # è·å– runs æ•°æ®
    local runs_json
    runs_json=$(docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -t -c \
        "SELECT runs FROM ai.agno_sessions WHERE session_id = '$session_id';" 2>/dev/null)
    
    if [ -z "$runs_json" ] || [ "$runs_json" = " " ]; then
        echo -e "${RED}âŒ æœªæ‰¾åˆ° session: $session_id${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“Š Trace: $session_id${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    case "$mode" in
        --full)
            echo ""
            echo -e "${BLUE}ğŸ”¹ å®Œæ•´ runs æ•°æ®:${NC}"
            echo "$runs_json" | jq '.[0]'
            ;;
        --metrics)
            echo ""
            echo -e "${BLUE}ğŸ”¹ æ‰§è¡ŒæŒ‡æ ‡:${NC}"
            echo "$runs_json" | jq '.[0].metrics'
            ;;
        --steps)
            echo ""
            echo -e "${BLUE}ğŸ”¹ èŠ‚ç‚¹ç»“æœ:${NC}"
            echo "$runs_json" | jq '.[0].step_results // .[0].messages // "N/A"'
            ;;
        --content)
            echo ""
            echo -e "${BLUE}ğŸ”¹ æœ€ç»ˆè¾“å‡º:${NC}"
            echo "$runs_json" | jq '.[0].content'
            ;;
        --usage)
            echo ""
            echo -e "${BLUE}ğŸ”¹ å·¥å…·æˆæœ¬ç»Ÿè®¡ (FinOps):${NC}"
            # ä» agno_spans æŸ¥è¯¢åŒ…å« __meta__ æˆ– AGNO_USAGE çš„å·¥å…·è°ƒç”¨
            # æ³¨æ„ï¼šJSON ä¸­çš„å¼•å·åœ¨ PostgreSQL ä¸­å­˜å‚¨ä¸º \" (è½¬ä¹‰)
            docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "
                WITH tool_costs AS (
                    SELECT 
                        s.name as tool_name,
                        CASE 
                            WHEN s.attributes::text LIKE '%status%billed%' THEN 'billed'
                            WHEN s.attributes::text LIKE '%status%free%' THEN 'free'
                            ELSE 'unknown'
                        END as status,
                        COALESCE(
                            (regexp_match(s.attributes::text, 'cost_usd[^0-9]*([0-9.]+)'))[1]::numeric,
                            0
                        ) as cost_usd
                    FROM ai.agno_spans s
                    JOIN ai.agno_traces t ON s.trace_id = t.trace_id
                    WHERE t.session_id = '$session_id'
                      AND (s.attributes::text LIKE '%__meta__%' OR s.attributes::text LIKE '%AGNO_USAGE%')
                      AND s.name NOT LIKE 'OpenRouter%'
                )
                SELECT 
                    tool_name as \"Tool\",
                    status as \"Status\",
                    '\$' || ROUND(cost_usd, 4) as \"Cost\"
                FROM tool_costs
                UNION ALL
                SELECT 
                    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€' as \"Tool\",
                    'â”€â”€â”€â”€â”€â”€' as \"Status\",
                    'â”€â”€â”€â”€â”€â”€â”€â”€' as \"Cost\"
                UNION ALL
                SELECT
                    'TOTAL' as \"Tool\",
                    '' as \"Status\",
                    '\$' || ROUND(SUM(cost_usd), 4) as \"Cost\"
                FROM tool_costs;
            "
            ;;
        --summary|*)
            echo ""
            echo -e "${BLUE}ğŸ”¹ çŠ¶æ€:${NC}"
            echo "$runs_json" | jq '.[0] | {status, workflow_name, agent_name, team_name, run_id, created_at} | with_entries(select(.value != null))'
            
            echo ""
            echo -e "${BLUE}ğŸ”¹ æŒ‡æ ‡æ‘˜è¦:${NC}"
            echo "$runs_json" | jq '.[0].metrics | if . then {duration, total_tokens: (.total_tokens // .input_tokens + .output_tokens // null), cost: (.cost // null)} | with_entries(select(.value != null)) else "N/A" end'
            
            echo ""
            echo -e "${BLUE}ğŸ”¹ èŠ‚ç‚¹æ‘˜è¦:${NC}"
            echo "$runs_json" | jq '
                if .[0].step_results then
                    [.[0].step_results[] | {step: .step_name, status: .status}]
                elif .[0].messages then
                    "Agent: \(.[0].messages | length) messages"
                else
                    "N/A"
                end
            '
            ;;
    esac
}

# æŸ¥çœ‹ session å†å²
cmd_sessions() {
    local type="${1:-all}"
    local id="$2"
    local limit="${3:-5}"
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“œ Session å†å²${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    local where_clause=""
    
    case "$type" in
        agent|agents)
            where_clause="WHERE agent_id IS NOT NULL"
            [ -n "$id" ] && where_clause="WHERE agent_id = '$id'"
            ;;
        team|teams)
            where_clause="WHERE team_id IS NOT NULL"
            [ -n "$id" ] && where_clause="WHERE team_id = '$id'"
            ;;
        workflow|workflows)
            where_clause="WHERE workflow_id IS NOT NULL"
            [ -n "$id" ] && where_clause="WHERE workflow_id = '$id'"
            ;;
        all)
            where_clause=""
            ;;
        *)
            echo -e "${RED}âŒ æœªçŸ¥ç±»å‹: $type${NC}"
            exit 1
            ;;
    esac
    
    docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c \
        "SELECT 
            session_id,
            COALESCE(agent_id, team_id, workflow_id) AS app_id,
            session_type,
            to_timestamp(created_at) AS created
         FROM ai.agno_sessions
         $where_clause
         ORDER BY created_at DESC
         LIMIT $limit;"
}

# æŸ¥çœ‹å¤±è´¥çš„ runs
cmd_errors() {
    local limit="10"
    
    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit)
                limit="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}âŒ æœ€è¿‘å¤±è´¥çš„ Runs (limit: $limit)${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "
        WITH failed_steps AS (
            SELECT 
                s.session_id,
                COALESCE(s.workflow_id, s.agent_id, s.team_id) as app_id,
                step_result->>'step_name' as step_name,
                step_result->>'status' as status,
                to_timestamp(s.created_at) as created_at
            FROM ai.agno_sessions s,
            jsonb_array_elements((s.runs->0->'step_results')::jsonb) as step_result
            WHERE step_result->>'status' = 'failed'
               OR step_result->>'success' = 'false'
        )
        SELECT 
            LEFT(session_id::text, 36) as \"Session ID\",
            COALESCE(app_id, 'N/A') as \"App\",
            COALESCE(step_name, 'N/A') as \"Failed Step\",
            to_char(created_at, 'YYYY-MM-DD HH24:MI') as \"Time\"
        FROM failed_steps
        ORDER BY created_at DESC
        LIMIT $limit;
    "
    
    echo ""
    echo -e "${CYAN}ğŸ’¡ æŸ¥çœ‹è¯¦æƒ…: agno trace <session_id> --steps${NC}"
}

# ç³»ç»Ÿå¥åº·æ£€æŸ¥
cmd_health() {
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # 1. API æœåŠ¡æ£€æŸ¥
    echo -n -e "${BLUE}ğŸ”Œ API æœåŠ¡:${NC} "
    if curl -4 -s --connect-timeout 3 "${BASE_URL}/health" > /dev/null 2>&1 || \
       curl -4 -s --connect-timeout 3 "${BASE_URL}/agents" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… æ­£å¸¸${NC} ($BASE_URL)"
    else
        echo -e "${RED}âŒ ä¸å¯ç”¨${NC} ($BASE_URL)"
    fi
    
    # 2. æ•°æ®åº“æ£€æŸ¥
    echo -n -e "${BLUE}ğŸ—„ï¸  æ•°æ®åº“:${NC} "
    if docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… æ­£å¸¸${NC} ($DB_CONTAINER)"
    else
        echo -e "${RED}âŒ ä¸å¯ç”¨${NC} ($DB_CONTAINER)"
    fi
    
    # 3. æœ€è¿‘ 1 å°æ—¶æˆåŠŸç‡
    echo -n -e "${BLUE}ğŸ“Š æœ€è¿‘1å°æ—¶æˆåŠŸç‡:${NC} "
    local stats
    stats=$(docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -t -c "
        WITH recent_runs AS (
            SELECT 
                s.session_id,
                CASE 
                    WHEN EXISTS (
                        SELECT 1 FROM jsonb_array_elements((s.runs->0->'step_results')::jsonb) as sr
                        WHERE sr->>'status' = 'failed' OR sr->>'success' = 'false'
                    ) THEN 'failed'
                    ELSE 'success'
                END as run_status
            FROM ai.agno_sessions s
            WHERE s.created_at > EXTRACT(EPOCH FROM NOW() - INTERVAL '1 hour')
        )
        SELECT 
            COUNT(*) as total,
            COUNT(*) FILTER (WHERE run_status = 'success') as success_count
        FROM recent_runs;
    " 2>/dev/null | tr -d ' ')
    
    if [ -n "$stats" ] && [ "$stats" != "|" ]; then
        local total=$(echo "$stats" | cut -d'|' -f1)
        local success=$(echo "$stats" | cut -d'|' -f2)
        if [ "$total" -gt 0 ]; then
            local rate=$(echo "scale=1; $success * 100 / $total" | bc)
            if (( $(echo "$rate >= 90" | bc -l) )); then
                echo -e "${GREEN}âœ… ${rate}%${NC} ($success/$total)"
            elif (( $(echo "$rate >= 70" | bc -l) )); then
                echo -e "${YELLOW}âš ï¸  ${rate}%${NC} ($success/$total)"
            else
                echo -e "${RED}âŒ ${rate}%${NC} ($success/$total)"
            fi
        else
            echo -e "${YELLOW}âš ï¸  æ— æ•°æ®${NC}"
        fi
    else
        echo -e "${YELLOW}âš ï¸  æ— æ•°æ®${NC}"
    fi
    
    # 4. æœ€è¿‘å¤±è´¥
    echo -e "${BLUE}ğŸ”´ æœ€è¿‘å¤±è´¥:${NC}"
    docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -t -c "
        WITH failed_steps AS (
            SELECT 
                COALESCE(s.workflow_id, s.agent_id, s.team_id) as app_id,
                step_result->>'step_name' as step_name,
                to_timestamp(s.created_at) as created_at
            FROM ai.agno_sessions s,
            jsonb_array_elements((s.runs->0->'step_results')::jsonb) as step_result
            WHERE (step_result->>'status' = 'failed' OR step_result->>'success' = 'false')
              AND s.created_at > EXTRACT(EPOCH FROM NOW() - INTERVAL '24 hours')
        )
        SELECT '   ' || COALESCE(step_name, 'N/A') || ' (' || app_id || ') - ' || 
               to_char(created_at, 'HH24:MI')
        FROM failed_steps
        ORDER BY created_at DESC
        LIMIT 3;
    " 2>/dev/null || echo "   (æ— )"
    
    echo ""
}

# ä¸»å…¥å£
main() {
    check_deps
    
    local cmd="${1:-help}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        run)
            cmd_run "$@"
            ;;
        trace)
            cmd_trace "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        sessions|history)
            cmd_sessions "$@"
            ;;
        errors)
            cmd_errors "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}âŒ æœªçŸ¥å‘½ä»¤: $cmd${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
